name: Build Android APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    # 1. ç¯å¢ƒå‡†å¤‡
    # ä½¿ç”¨ Temurin å‘è¡Œç‰ˆï¼Œè¿™æ˜¯ Flutter å®˜æ–¹æ¨èçš„ Java ç¯å¢ƒ
    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    # å…³é”®ä¿®æ”¹ï¼šä½¿ç”¨ stable æ¸ é“ï¼Œç¡®ä¿ Flutter ç‰ˆæœ¬ä¸æœ€æ–° Flet å…¼å®¹
    # ä¹‹å‰æŒ‡å®š 3.19.0 å¯èƒ½å¯¼è‡´ä¸æœ€æ–° Flet ç‰ˆæœ¬ä¸å…¼å®¹
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        cache: true

    # é¢„é˜²æ€§æªæ–½ï¼šæ¥å— Android SDK åè®®
    - name: Accept Android Licenses
      run: |
        yes | sdkmanager --licenses || true

    # 2. æ™ºèƒ½æ„å»º
    - name: Smart Build
      run: |
        echo "ğŸ” Searching for main.py..."
        MAIN_FILE=$(find . -type f -name "main.py" -not -path "*/.*" | head -n 1)
        
        if [ -z "$MAIN_FILE" ]; then
          echo "âŒ Error: main.py not found!"
          ls -R
          exit 1
        fi
        
        echo "âœ… Found main app file: $MAIN_FILE"
        APP_ROOT=$(dirname "$MAIN_FILE")
        
        # è¿›å…¥é¡¹ç›®ç›®å½•
        cd "$APP_ROOT"
        
        echo "ğŸ“¦ Installing dependencies..."
        python -m pip install --upgrade pip
        
        # å¼ºåˆ¶å®‰è£…æœ€æ–°ç‰ˆ flet
        pip install flet
        
        if [ -f "requirements.txt" ]; then
          pip install -r requirements.txt
        else
          # è‡ªåŠ¨è¡¥å…¨å¸¸ç”¨ä¾èµ–
          pip install requests beautifulsoup4 pytz
        fi
        
        echo "ğŸš€ Starting Flet Build (Verbose Mode)..."
        # ä½¿ç”¨ -vv è¾“å‡ºæ›´å¤šè°ƒè¯•ä¿¡æ¯
        flet build apk --verbose

    # 3. ä¸Šä¼ ç»“æœ
    - name: Upload APK
      if: success()
      uses: actions/upload-artifact@v3
      with:
        name: football-fixtures-apk
        path: |
          **/*.apk
          build/apk/app-release.apk
