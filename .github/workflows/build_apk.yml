name: Build Android APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    # 1. ç¯å¢ƒå‡†å¤‡ï¼šAndroid æ„å»ºå¿…é¡»ä¾èµ– Java (è¿™æ˜¯ä¹‹å‰å¤±è´¥çš„å…³é”®åŸå› )
    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.19.0'

    # 2. æ™ºèƒ½æ„å»º (è‡ªåŠ¨å¯»æ‰¾é¡¹ç›®ç›®å½•ï¼Œé˜²æ­¢æ–‡ä»¶å¤¹åµŒå¥—å¯¼è‡´æ‰¾ä¸åˆ°æ–‡ä»¶)
    - name: Smart Build
      run: |
        echo "ğŸ” Searching for main.py..."
        # æŸ¥æ‰¾ main.pyï¼Œæ’é™¤éšè—ç›®å½•
        MAIN_FILE=$(find . -type f -name "main.py" -not -path "*/.*" | head -n 1)
        
        if [ -z "$MAIN_FILE" ]; then
          echo "âŒ Error: main.py not found in the repository!"
          echo "ğŸ“‚ Current file structure:"
          ls -R
          exit 1
        fi
        
        echo "âœ… Found main app file: $MAIN_FILE"
        APP_ROOT=$(dirname "$MAIN_FILE")
        echo "ğŸ“‚ Project Root: $APP_ROOT"
        
        # è¿›å…¥é¡¹ç›®ç›®å½•
        cd "$APP_ROOT"
        
        echo "ğŸ“¦ Installing dependencies..."
        pip install --upgrade pip
        # å¼ºåˆ¶å®‰è£… fletï¼Œç¡®ä¿æ„å»ºå·¥å…·å­˜åœ¨
        pip install flet
        
        if [ -f "requirements.txt" ]; then
          echo "ğŸ“„ Found requirements.txt, installing..."
          pip install -r requirements.txt
        else
          echo "âš ï¸ No requirements.txt found, installing detected packages..."
          # å³ä½¿æ²¡æœ‰ requirements.txt ä¹Ÿè‡ªåŠ¨è¡¥å…¨ä¾èµ–
          pip install requests beautifulsoup4 pytz
        fi
        
        echo "ğŸš€ Starting Flet Build..."
        # ä½¿ç”¨ -v å¼€å¯è¯¦ç»†æ—¥å¿—ï¼Œæ–¹ä¾¿æ’æŸ¥
        flet build apk --verbose

    # 3. ä¸Šä¼ ç»“æœ (åŒ¹é…æ‰€æœ‰ç”Ÿæˆçš„ APK)
    - name: Upload APK
      if: success()
      uses: actions/upload-artifact@v3
      with:
        name: football-fixtures-apk
        path: |
          **/*.apk
