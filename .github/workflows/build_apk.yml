name: Build Android APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    # 1. è°ƒè¯•ä¿¡æ¯
    - name: Debug File System
      run: |
        echo "ðŸ“‚ Current Directory:"
        pwd
        echo "ðŸ“‚ File List (Recursive):"
        ls -R

    # 2. çŽ¯å¢ƒé…ç½®
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        cache: true

    # 3. æ™ºèƒ½æž„å»º
    - name: Build with Flet
      run: |
        echo "ðŸ” Searching for main.py..."
        MAIN_PATH=$(find . -name "main.py" -not -path "*/.*" | head -n 1)
        
        if [ -z "$MAIN_PATH" ]; then
          echo "âŒ Fatal: main.py not found!"
          exit 1
        fi
        
        WORK_DIR=$(dirname "$MAIN_PATH")
        cd "$WORK_DIR"
        
        echo "ðŸ“¦ Installing dependencies..."
        python -m pip install --upgrade pip
        pip install flet requests beautifulsoup4 pytz
        
        echo "ðŸ“ Accepting Android licenses..."
        yes | sdkmanager --licenses > /dev/null 2>&1 || true
        
        echo "ðŸš€ Starting build..."
        flet build apk --verbose

    # 4. ä¸Šä¼ ç»“æžœ
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: football-fixtures-apk
        path: |
          **/*.apk
