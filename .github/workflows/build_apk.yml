name: Build Android APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    # 1. è°ƒè¯•ä¿¡æ¯ï¼šæ‰“å°å½“å‰æ–‡ä»¶ç»“æ„ï¼Œå¸®åŠ©æ’æŸ¥è·¯å¾„é—®é¢˜
    - name: Debug File System
      run: |
        echo "ğŸ“‚ Current Directory:"
        pwd
        echo "ğŸ“‚ File List (Recursive):"
        ls -R

    # 2. ç¯å¢ƒé…ç½®
    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        cache: true

    # 3. è¯Šæ–­ Flutter ç¯å¢ƒ
    - name: Flutter Doctor
      run: flutter doctor -v

    # 4. æ™ºèƒ½å®‰è£…ä¾èµ–ä¸æ„å»º
    - name: Build with Flet
      run: |
        echo "ğŸ” Searching for main.py..."
        # æŸ¥æ‰¾ main.pyï¼Œæ’é™¤éšè—ç›®å½•
        MAIN_PATH=$(find . -name "main.py" -not -path "*/.*" | head -n 1)
        
        if [ -z "$MAIN_PATH" ]; then
          echo "âŒ Fatal: main.py not found in the repository!"
          echo "Please ensure you have uploaded the code correctly."
          exit 1
        fi
        
        # åˆ‡æ¢åˆ° main.py æ‰€åœ¨ç›®å½•
        WORK_DIR=$(dirname "$MAIN_PATH")
        echo "âœ… Found main.py at: $MAIN_PATH"
        echo "ğŸ“‚ Switching to directory: $WORK_DIR"
        cd "$WORK_DIR"
        
        # å®‰è£…ä¾èµ– (ç›´æ¥æŒ‡å®šåŒ…åï¼Œé˜²æ­¢ requirements.txt è¯»å–å¤±è´¥)
        echo "ğŸ“¦ Installing Python dependencies..."
        python -m pip install --upgrade pip
        pip install flet requests beautifulsoup4 pytz
        
        # æ¥å— Android åè®® (é¢„é˜²æ€§)
        echo "ğŸ“ Accepting Android licenses..."
        yes | sdkmanager --licenses > /dev/null 2>&1 || true
        
        # å¼€å§‹æ„å»º
        echo "ğŸš€ Starting build..."
        flet build apk --verbose

    # 5. ä¸Šä¼ ç»“æœ (ä½¿ç”¨é€šé…ç¬¦åŒ¹é…æ‰€æœ‰å¯èƒ½çš„è·¯å¾„)
    - name: Upload APK
      if: success()
      uses: actions/upload-artifact@v3
      with:
        name: football-fixtures-apk
        path: |
          **/*.apk
